---
title: "SEACAR code review"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
  word_document:
    toc: true
    number_sections: true
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding,
  output_dir = ".", output_format = c("html_document", "word_document")) })
date: "`r Sys.time()`"
author: "Marcus W. Beck, mbeck@tbep.org"
---

```{r setup, include = FALSE, warning = F, message = F}
knitr::opts_chunk$set(echo = F, warning = F, message = F)

box::use(
  here[...],
  dplyr[...], 
  knitr[kable],
  ../R/funcs[scrptflt, scrptinp, scrptout, scrptlib]
)

fls <- read.csv(here('data/seacarfiles.csv')) %>% 
  rename(File = file) %>% 
  arrange(category, File)

flsnow <- list.files(here(), '\\.R$') %>% 
  tibble(File = .)

# silly check if files in the dir are not the lookup table
stopifnot(flsnow$File %in% fls$File)

# get only files with 'final' in the name
fls <- fls %>% 
  filter(grepl('final', tolower(File)))

# create text to other format
frmtxt <- 'View as [HTML document](https://FloridaSEACAR.github.io/SEACAR/review.html)'
if (knitr::is_html_output())
  frmtxt <- 'View as [Word document](https://github.com/FloridaSEACAR/SEACAR/raw/marcus/docs/review.docx)'
```

`r frmtxt`

# Document overview 

SEACAR is a collaborative process which involves local, state and federal natural resource managers, data providers, researchers and partners to identify and assess ecological indicators and to develop a decision support tool to better understand the status of aquatic resources throughout the Office of Resilience and Coastal Protection managed areas. SEACAR staff are working with the University of South Florida (USF) Water Institute to create an online platform for data analysis and reporting to support science-based decisions of coastal resources in Florida. Analysis routines have been created to import, format, and summarize status and trends for various metrics of coastal condition reported by habitat, indicators, multiple parameters per indicator, and across 47 management areas. Primary habitats include water column, submerged aquatic vegetation, coral reefs, oyster reefs, and coastal wetlands.

To date, several scripts written using the R statistical programming language have been produced. This document is a review of these analysis scripts, as currently delivered in two separate GitHub repositories (available at https://github.com/FloridaSEACAR). This review includes a description of the purpose of each script to ensure the outputs are as expected based on preliminary goals established for the project. In general, status and trends of key indicators is to be quantified using conventional, non-parametric methods following the seasonal Kendall tau test that assesses direction and magnitude of a change within a specified period of time. Minimum requirements for the trend tests for each indicator include at least five years of data with at least two months in common across at least two consecutive years for each managed area. In addition, linear mixed-effects models have been used to assess trends in seagrass coverage.

This review is delivered as a bulleted outline for each script describing the objective, required inputs, processing steps, and output (e.g., graphic, summary table). The tests run or summaries created are described. The extent to which each indicator fulfills the requirements for the applicable trend test is also assessed, e.g., by describing available years of data or if data are insufficient. Each script is also reviewed for coding best practices to identify areas that can be improved or shortened for efficiency and to identify potential mistakes or errors in calculation. Specific lines are referenced as needed to identify areas in need of improvement or further review. Outputs, such as graphics or tabular summaries, are also reviewed to identify potential improvements in future versions of the code.

# Comments by habitat type

## Water column

### Scripts: {-}

```{r}
scrpt <- scrptflt(fls, 'wc')
kable(scrpt)
```

### Summaries: {-}

```{r}
fl <- scrpt$File[1]
```
1. `r fl`
     * Objective: Import and format phosphorus data, create summary boxplots, evaluate trends with seasonal Kendall tests.
     * Packages: `r scrptlib(fl)`
     * File inputs: `r scrptinp(fl)`
     * Steps by line number:
          * Lines 1 - 52: load libraries and import phosphorus and regions datasets
          * Lines 53 - 187: Format data for analysis, including removal of NA values, conversion of date column to date objects, and removing entries with flagged QA codes (from WIN and NERRS data).  NA values are removed for water quality measurements and dates.
          * Lines 188 - 206: boxplot summaries of surface phosphorus by year, year/month for complete dataset
          * Lines 208 - 222: boxplot summaries of surface phosphorus by year/month, separate for managed areas
          * Lines 223 - 239: boxplot summaries of surface phosphorus by year, separate for managed areas
          * Lines 240 - 264: average phosphorus by year, month, managed area to prep for trend test
          * Lines 265 - 322: identify number of unique years in each dataset, remove those with < 10
          * Lines 323 - 349: plots of average year, month phosphorus, separate for managed areas
          * Lines 350 - 368: run trend tests, first on a "test" site then for all, results saved as raw output from the trend test
          * Lines 369 - 440: format all trend tests in a simple table, combine with region names, save output as csv
     * File outputs: `r scrptout(fl)`
     * Potential issues: 
          * Line 41: object `regions` called before import
          * Line 202 (and others): boxplot summaries should be on log-scale
          * NA values were also removed for dates that were incomplete.  This may possibly be corrected through additional formatting but is not done here. 
          * Values at MDL are not removed, these need to be treated separately before running trend tests, i.e., estimate averages using appropriate statistics that account for left-censored data.
```{r}
fl <- scrpt$File[2]
```
1. `r fl`
     * Objective: Import and format CDOM data, create summary boxplots, evaluate trends with seasonal Kendall tests.
     * Packages: `r scrptlib(fl)`
     * File inputs: `r scrptinp(fl)`
     * Steps by line number:
          * Lines 1 - 49: load libraries and import CDOM and regions datasets
          * Lines 50 - 186: Format data for analysis, including removal of NA values, conversion of date column to date objects, and removing entries with flagged QA codes (from WIN and NERRS data).  NA values are removed for water quality measurements and dates.
          * Lines 187 - 205: boxplot summaries of surface CDOM by year, year/month for complete dataset
          * Lines 206 - 216: boxplot summaries of surface CDOM by year/month, separate for managed areas
          * Lines 217 - 238: boxplot summaries of surface CDOM by year, separate for managed areas
          * Lines 239 - 262: average CDOM by year, month, managed area to prep for trend test
          * Lines 263 - 320: identify number of unique years in each dataset, remove those with < 10
          * Lines 321 - 347: plots of average year, month CDOM, separate for managed areas
          * Lines 350 - 366: run trend tests, first on a "test" site then for all, results saved as raw output from the trend test
          * Lines 367 - 438: format all trend tests in a simple table, combine with region names, save output as csv
     * File outputs: `r scrptout(fl)`
     * Potential issues: 
          * Line 201 (and others): boxplot summaries should be on log-scale
          * Line 269: object name has a reserved character (-) and cannot be created
          * Line 359: object name has a reserved character (-) and cannot be created
          * Line 371: object name has a reserved character (-) and cannot be created
          * NA values were also removed for dates that were incomplete.  This may possibly be corrected through additional formatting but is not done here. 
          * Values at MDL are not removed, these need to be treated separately before running trend tests, i.e., estimate averages using appropriate statistics that account for left-censored data.
```{r}
fl <- scrpt$File[3]
```
1. `r fl`
     * Objective: Import and format chlorophyll data, create summary boxplots, evaluate trends with seasonal Kendall tests.
     * Packages: `r scrptlib(fl)`
     * File inputs: `r scrptinp(fl)`
     * Steps by line number:
          * Lines 1 - 49: load libraries and import chlorophyll and regions datasets
          * Lines 50 - 185: Format data for analysis, including removal of NA values, conversion of date column to date objects, and removing entries with flagged QA codes (from WIN and NERRS data).  NA values are removed for water quality measurements and dates.
          * Lines 186 - 205: boxplot summaries of surface chlorophyll by year, year/month for complete dataset
          * Lines 206 - 220: boxplot summaries of surface chlorophyll by year/month, separate for managed areas
          * Lines 221 - 237: boxplot summaries of surface chlorophyll by year, separate for managed areas
          * Lines 238 - 261: average chlorophyll by year, month, managed area to prep for trend test
          * Lines 262 - 319: identify number of unique years in each dataset, remove those with < 10
          * Lines 320 - 346: plots of average year, month chlorophyll, separate for managed areas
          * Lines 347 - 365: run trend tests, first on a "test" site then for all, results saved as raw output from the trend test
          * Lines 366 - 437: format all trend tests in a simple table, combine with region names, save output as csv
     * File outputs: `r scrptout(fl)`
     * Potential issues: 
          * Line 205 (and others): boxplot summaries should be on log-scale
          * NA values were also removed for dates that were incomplete.  This may possibly be corrected through additional formatting but is not done here. 
          * Values at MDL are not removed, these need to be treated separately before running trend tests, i.e., estimate averages using appropriate statistics that account for left-censored data.
```{r}
fl <- scrpt$File[4]
```
1. `r fl`
     * Objective: Import and format turbidity data, create summary boxplots, evaluate trends with seasonal Kendall tests.
     * Packages: `r scrptlib(fl)`
     * File inputs: `r scrptinp(fl)`
     * Steps by line number:
          * Lines 1 - 50: load libraries and import turbidity and regions datasets
          * Lines 51 - 186: Format data for analysis, including removal of NA values, conversion of date column to date objects, and removing entries with flagged QA codes (from WIN and NERRS data).  NA values are removed for water quality measurements and dates.
          * Lines 187 - 205: boxplot summaries of surface turbidity by year, year/month for complete dataset
          * Lines 206 - 221: boxplot summaries of surface turbidity by year/month, separate for managed areas
          * Lines 222 - 238: boxplot summaries of surface turbidity by year, separate for managed areas
          * Lines 239 - 262: average turbidity by year, month, managed area to prep for trend test
          * Lines 263 - 320: identify number of unique years in each dataset, remove those with < 10
          * Lines 321 - 347: plots of average year, month turbidity, separate for managed areas
          * Lines 348 - 366: run trend tests, first on a "test" site then for all, results saved as raw output from the trend test
          * Lines 367 - 438: format all trend tests in a simple table, combine with region names, save output as csv
     * File outputs: `r scrptout(fl)`
     * Potential issues: 
          * Line 201 (and others): boxplot summaries should be on log-scale
          * NA values were also removed for dates that were incomplete.  This may possibly be corrected through additional formatting but is not done here. 
          * Values at MDL are not removed, these need to be treated separately before running trend tests, i.e., estimate averages using appropriate statistics that account for left-censored data.
```{r}
fl <- scrpt$File[5]
```
1. `r fl`
     * Objective: Import and format nitrogen data, create summary boxplots, evaluate trends with seasonal Kendall tests.
     * Packages: `r scrptlib(fl)`
     * File inputs: `r scrptinp(fl)`
     * Steps by line number:
          * Lines 1 - 48: load libraries and import nitrogen and regions datasets
          * Lines 49 - 219: Format data for analysis, including removal of NA values, conversion of date column to date objects, and removing entries with flagged QA codes (from WIN and NERRS data).  NA values are removed for water quality measurements and dates.  Creates TN as sum of TKN and NOx.  Values less than zero are flagged as 999999999, which is different from the other water quality variables.
          * Lines 220 - 239: boxplot summaries of surface nitrogen by year, year/month for complete dataset
          * Lines 240 - 255: boxplot summaries of surface nitrogen by year/month, separate for managed areas
          * Lines 256 - 272: boxplot summaries of surface nitrogen by year, separate for managed areas
          * Lines 273 - 296: average nitrogen by year, month, managed area to prep for trend test
          * Lines 297 - 354: identify number of unique years in each dataset, remove those with < 10
          * Lines 355 - 381: plots of average year, month nitrogen, separate for managed areas
          * Lines 382 - 400: run trend tests, first on a "test" site then for all, results saved as raw output from the trend test
          * Lines 401 - 472: format all trend tests in a simple table, combine with region names, save output as csv
     * File outputs: `r scrptout(fl)`
     * Potential issues: 
          * Line 115: Date conversion is incorrect, creates all `NA` preventing downstream analysis
          * Line 235 (and others): boxplot summaries should be on log-scale
          * NA values were also removed for dates that were incomplete.  This may possibly be corrected through additional formatting but is not done here. 
          * Values at MDL are not removed, these need to be treated separately before running trend tests, i.e., estimate averages using appropriate statistics that account for left-censored data.
          * Many of the plots of the observed or averaged data are suspect, with large jumps in values between years, possibly related to changing lab methods or incorrect sum to get TN.  
```{r}
fl <- scrpt$File[6]
```
1. `r fl`
     * Objective: Import and format dissolved oxygen saturation data, create summary boxplots, evaluate trends with seasonal Kendall tests.
     * Packages: `r scrptlib(fl)`
     * File inputs: `r scrptinp(fl)`
     * Steps by line number:
          * Lines 1 - 49: load libraries and import dissolved oxygen saturation and regions datasets
          * Lines 50 - 193: Format data for analysis, including removal of NA values, conversion of date column to date objects, and removing entries with flagged QA codes (from WIN and NERRS data)
          * Lines 194 - 212: boxplot summaries of surface dissolved oxygen saturation by year, year/month for complete dataset
          * Lines 213 - 228: boxplot summaries of surface dissolved oxygen saturation by year/month, separate for managed areas
          * Lines 229 - 245: boxplot summaries of surface dissolved oxygen saturation by year, separate for managed areas
          * Lines 246 - 269: average dissolved oxygen saturation by year, month, managed area to prep for trend test
          * Lines 270 - 327: identify number of unique years in each dataset, remove those with < 10
          * Lines 328 - 354: plots of average year, month dissolved oxygen saturation, separate for managed areas
          * Lines 355 - 373: run trend tests, first on a "test" site then for all, results saved as raw output from the trend test
          * Lines 374 - 445: format all trend tests in a simple table, combine with region names, save output as csv
     * File outputs: `r scrptout(fl)`
     * Potential issues: 
          * NA values were also removed for dates that were incomplete.  This may possibly be corrected through additional formatting but is not done here. 
          * Many of the plots of the observed or averaged data are suspect, with large jumps in values between years.
```{r}
fl <- scrpt$File[7]
```
1. `r fl`
     * Objective: Import and format dissolved oxygen concentration data, create summary boxplots, evaluate trends with seasonal Kendall tests.
     * Packages: `r scrptlib(fl)`
     * File inputs: `r scrptinp(fl)`
     * Steps by line number:
          * Lines 1 - 49: load libraries and import dissolved oxygen concentration and regions datasets
          * Lines 50 - 193: Format data for analysis, including removal of NA values, conversion of date column to date objects, and removing entries with flagged QA codes (from WIN and NERRS data)
          * Lines 194 - 212: boxplot summaries of surface dissolved oxygen concentration by year, year/month for complete dataset
          * Lines 213 - 228: boxplot summaries of surface dissolved oxygen concentration by year/month, separate for managed areas
          * Lines 229 - 245: boxplot summaries of surface dissolved oxygen concentration by year, separate for managed areas
          * Lines 246 - 269: average dissolved oxygen concentration by year, month, managed area to prep for trend test
          * Lines 270 - 327: identify number of unique years in each dataset, remove those with < 10
          * Lines 328 - 354: plots of average year, month dissolved oxygen concentration, separate for managed areas
          * Lines 355 - 373: run trend tests, first on a "test" site then for all, results saved as raw output from the trend test
          * Lines 374 - 445: format all trend tests in a simple table, combine with region names, save output as csv
     * File outputs: `r scrptout(fl)`
     * Potential issues: 
          * NA values were also removed for dates that were incomplete.  This may possibly be corrected through additional formatting but is not done here. 
          * Many of the plots of the observed or averaged data are suspect, with large jumps in values between years.
```{r}
fl <- scrpt$File[8]
```
1. `r fl`
     * Objective: Import and format pH data, create summary boxplots, evaluate trends with seasonal Kendall tests.
     * Packages: `r scrptlib(fl)`
     * File inputs: `r scrptinp(fl)`
     * Steps by line number:
          * Lines 1 - 49: load libraries and import pH and regions datasets
          * Lines 50 - 193: Format data for analysis, including removal of NA values, conversion of date column to date objects, and removing entries with flagged QA codes (from WIN and NERRS data)
          * Lines 194 - 212: boxplot summaries of surface pH by year, year/month for complete dataset
          * Lines 213 - 228: boxplot summaries of surface pH by year/month, separate for managed areas
          * Lines 229 - 245: boxplot summaries of surface pH by year, separate for managed areas
          * Lines 246 - 269: average pH by year, month, managed area to prep for trend test
          * Lines 270 - 327: identify number of unique years in each dataset, remove those with < 10
          * Lines 328 - 354: plots of average year, month pH, separate for managed areas
          * Lines 355 - 373: run trend tests, first on a "test" site then for all, results saved as raw output from the trend test
          * Lines 374 - 445: format all trend tests in a simple table, combine with region names, save output as csv
     * File outputs: `r scrptout(fl)`
     * Potential issues: 
          * The pH file is 1Gb, not sure this is a huge issue but import time is longer than most files.  
          * NA values were also removed for dates that were incomplete.  This may possibly be corrected through additional formatting but is not done here. 
          * Many of the plots of the observed or averaged data are suspect, with large jumps in values between years.
```{r}
fl <- scrpt$File[9]
```
1. `r fl`
     * Objective: Import and format salinity data, create summary boxplots, evaluate trends with seasonal Kendall tests.
     * Packages: `r scrptlib(fl)`
     * File inputs: `r scrptinp(fl)`
     * Steps by line number:
          * Lines 1 - 49: load libraries and import salinity and regions datasets
          * Lines 50 - 193: Format data for analysis, including removal of NA values, conversion of date column to date objects, and removing entries with flagged QA codes (from WIN and NERRS data)
          * Lines 194 - 212: boxplot summaries of surface salinity by year, year/month for complete dataset
          * Lines 213 - 228: boxplot summaries of surface salinity by year/month, separate for managed areas
          * Lines 229 - 245: boxplot summaries of surface salinity by year, separate for managed areas
          * Lines 246 - 269: average salinity by year, month, managed area to prep for trend test
          * Lines 270 - 327: identify number of unique years in each dataset, remove those with < 10
          * Lines 328 - 354: plots of average year, month salinity, separate for managed areas
          * Lines 355 - 373: run trend tests, first on a "test" site then for all, results saved as raw output from the trend test
          * Lines 374 - 445: format all trend tests in a simple table, combine with region names, save output as csv
     * File outputs: `r scrptout(fl)`
     * Potential issues: 
          * NA values were also removed for dates that were incomplete.  This may possibly be corrected through additional formatting but is not done here. 
          * Many of the plots of the observed or averaged data are suspect, with large jumps in values between years.
```{r}
fl <- scrpt$File[10]
```
1. `r fl`
     * Objective: Import and format temperature data, create summary boxplots, evaluate trends with seasonal Kendall tests.
     * Packages: `r scrptlib(fl)`
     * File inputs: `r scrptinp(fl)`
     * Steps by line number:
          * Lines 1 - 49: load libraries and import temperature and regions datasets
          * Lines 50 - 193: Format data for analysis, including removal of NA values, conversion of date column to date objects, and removing entries with flagged QA codes (from WIN and NERRS data)
          * Lines 194 - 212: boxplot summaries of surface temperature by year, year/month for complete dataset
          * Lines 213 - 228: boxplot summaries of surface temperature by year/month, separate for managed areas
          * Lines 229 - 245: boxplot summaries of surface temperature by year, separate for managed areas
          * Lines 246 - 269: average temperature by year, month, managed area to prep for trend test
          * Lines 270 - 327: identify number of unique years in each dataset, remove those with < 10
          * Lines 328 - 354: plots of average year, month temperature, separate for managed areas
          * Lines 355 - 373: run trend tests, first on a "test" site then for all, results saved as raw output from the trend test
          * Lines 374 - 445: format all trend tests in a simple table, combine with region names, save output as csv
     * File outputs: `r scrptout(fl)`
     * Potential issues: 
          * The temperature file is 1Gb, not sure this is a huge issue but import time is longer than most files.
          * NA values were also removed for dates that were incomplete.  This may possibly be corrected through additional formatting but is not done here. 
          * Many of the plots of the observed or averaged data are suspect, with large jumps in values between years.
```{r}
fl <- scrpt$File[11]
```
1. `r fl`
     * Objective: Import and format nekton data, calculate richness, assess trends with linear mixed effects models.
     * Packages: `r scrptlib(fl)`
     * File inputs: `r scrptinp(fl)`
     * Steps by line number:
          * Lines 1 - 19: load libraries and import nekton data
          * Lines 20 - 30: combine genus, species columns as one, remove any rows with missing genus or management area names 
          * Lines 31 - 52: calculate richness metrics management area, region, year
          * Lines 53 - 69: identify number of unique years in each dataset, remove those with < 5
          * Lines 70 - 86: create linear mixed models evaluating richness vs year, using a random region effect
          * Lines 87 - 113: create plot of richness vs year by management area using model output
          * Lines 114 - 141: tabular summary of richness vs year by  management area
          * Lines 142 - 166: tabular summary of richness vs year by management area, similar info as previous table
          * Lines 167 - 200: join results from the previous two tables, save output as csv
     * File outputs: `r scrptout(fl)`
     * Potential issues: 
          * Line 38: `NA` values are incorrectly identified, should do this with a regular expression search.
          * If the goal is to evaluate diversity, this was not done.  Only richness was evaluated.
          * There are redundant models created for the plots and tables.  These should only be created once and recycled as needed.
          * There are some outlier values for one of the managed areas in the species richness vs year plot that should be verified.
          
## Coral reef

### Scripts: {-}

```{r}
scrpt <- scrptflt(fls, 'co')
kable(scrpt)
```

### Summaries: {-}

```{r}
fl <- scrpt$File[1]
```
1. `r fl`
     * Objective: import nekton and coral data, combine, assess relationships between nekton richness and coral cover by managed area.
     * Packages: `r scrptlib(fl)`
     * File inputs: `r scrptinp(fl)`
     * Steps by line number:
          * Lines 1 - 43: import coral data for each region (Dry Tortugas, Florida Keys, SE Florida), filter by managed area names, combine all into one object
          * Lines 44 - 65: import nekton data, filter by grazers and reef dependent species
          * Lines 66 - 90: estimate nekton richness by managed area, year, estimate coral percent cover by managed area, year, combine into one dataset
          * Lines 91 - 103: create linear mixed effects model of nekton richness by mean percent coral cover, year as random effect, output as csv
          * Lines 104 - 124: create linear mixed effects model of nekton richness by mean percent coral cover, year as random effect, separate models by managed area, output as csv 
          * Lines 125 - 149: create plots of nekton richness vs coral percent cover from model output, save as pdf
          * Lines 150 - 236: format and summarize model output to create summary table of model fit, saved as csv
     * File outputs: `r scrptout(fl)`
     * Potential issues: 
          * Requires data inputs created in files FINAL 2021.09.18_SE Region_AnyCorals.R, FINAL_2021.09.18_FLAKEYS_AnyCorals.R, FINAL_2021.09.18_DryTort Region_Any Corals.R.  The Nekton2.csv file is created from Nekton_SE-2021-Jul-26.csv.
```{r}
fl <- scrpt$File[2]
```
1. `r fl`
     * Objective: Import and format percent cover data, create summary boxplots, evaluate percent cover trends for any corals across years with linear models.
     * Packages: `r scrptlib(fl)`
     * File inputs: `r scrptinp(fl)`
     * Steps by line number:
          * Lines 1 - 20: load libraries and import percent cover data for Dry Tortugas
          * Lines 21 - 79: format data for analysis including removal of non-coral taxa, renaming columns, removing `NA` percent cover data, combining genus/species columns, and removing missing rows for genus/species
          * Lines 80 - 101: create a summary table for percent cover statistics by year, region across all species, save output
          * Lines 102 - 112: create linear model year vs percent cover, save model summary plots to pdf
          * Lines 113 - 128: create boxplots of percent cover for any coral by year, save as pdf
          * Lines 129 - 145: create linear mixed effects model of percent cover for any coral vs year, random effect for program location ID
          * Lines 146 - 179: create linear mixed effects model of percent cover for any coral vs year, random effect for program location ID, separate for coral region, save output as csv
          * Lines 180 - 202: plot model output as estimated linear trend across years by coral region, save as pdf
          * Lines 203 - 301: format and summarize model output to create summary table of model fit, saved as csv
     * File outputs: `r scrptout(fl)`
     * Potential issues: 
          * Lines 106, 109: Year is dependent variable in the linear model, it should be the independent variable.
          * Model results are separate for each coral region, yet the file includes only one region (Dry Tortugas). This does not create incorrect output, but the intention is unclear.
```{r}
fl <- scrpt$File[3]
```
1. `r fl`
     * Objective: Import and format percent cover data, create summary boxplots, evaluate percent cover trends by genus across years with linear models.
     * Packages: `r scrptlib(fl)`
     * File inputs: `r scrptinp(fl)`
     * Steps by line number:
          * Lines 1 - 18: load libraries and import percent cover data for Dry Tortugas
          * Lines 19 - 83: format data for analysis including removal of non-coral taxa, renaming columns, removing `NA` percent cover data, combining genus/species columns, and removing missing rows for genus/species
          * Lines 84 - 103: create a summary table for percent cover statistics by year, genus, region, save output
          * Lines 104 - 110: create linear model year vs percent cover, not separated by genus
          * Lines 111 - 125: create boxplots of percent cover by genus, year, save as pdf
          * Lines 126 - 161: remove genera with less than ten years of data, create linear mixed effects model of percent cover for all genera vs year, random effect for program location ID.  No output created because no genus meets the minimum year requirement.
          * Lines 162 - 184: create linear mixed effects model of percent cover for each genus vs year, random effect for program location ID, save output as csv. No output created because no genus meets the minimum year requirement.
          * Lines 185 - 210: plot model output as estimated linear trend across years by genus, save as pdf. No output created because no genus meets the minimum year requirement.
          * Lines 211 - 309: format and summarize model output to create summary table of model fit, saved as csv.  No output created because no genus meets the minimum year requirement.
     * File outputs: `r scrptout(fl)`
     * Potential issues: 
          * Line 108: Year is dependent variable in the linear model, it should be the independent variable.
          * No output created because no genus meets the minimum year requirement.
```{r}
fl <- scrpt$File[4]
```
1. `r fl`
     * Objective: Import and format percent cover data, create summary boxplots, evaluate percent cover trends by species group across years with linear models.
     * Packages: `r scrptlib(fl)`
     * File inputs: `r scrptinp(fl)`
     * Steps by line number:
          * Lines 1 - 17: load libraries and import percent cover data for Dry Tortugas
          * Lines 18 - 81: format data for analysis including removal of non-coral taxa, renaming columns, removing `NA` percent cover data, combining genus/species columns, and removing missing rows for genus/species
          * Lines 82 - 101: create a summary table for percent cover statistics by year, species group, region, save output
          * Lines 102 - 107: create linear model year vs percent cover, not separated by species group
          * Lines 108 - 122: create boxplots of percent cover by species group, year, save as pdf
          * Lines 123 - 158: create linear mixed effects model of percent cover for each species group vs year, random effect for program location ID, save as csv
          * Lines 159 - 181: plot model output as estimated linear trend across years by species group, save as pdf
          * Lines 182 - 280: format and summarize model output to create summary table of model fit, saved as csv
     * File outputs: `r scrptout(fl)`
     * Potential issues: 
          * Line 106: Year is dependent variable in the linear model, it should be the independent variable.
```{r}
fl <- scrpt$File[5]
```
1. `r fl`
     * Objective: Import and format percent cover data, create summary boxplots, evaluate percent cover trends for any corals across years with linear models.
     * Packages: `r scrptlib(fl)`
     * File inputs: `r scrptinp(fl)`
     * Steps by line number:
          * Lines 1 - 20: load libraries and import percent cover data for Florida Keys
          * Lines 21 - 79: format data for analysis including removal of non-coral taxa, renaming columns, removing `NA` percent cover data, combining genus/species columns, and removing missing rows for genus/species
          * Lines 80 - 101: create a summary table for percent cover statistics by year, region across all species, save output
          * Lines 102 - 112: create linear model year vs percent cover, save model summary plots to pdf
          * Lines 113 - 127: create boxplots of percent cover for any coral by year, save as pdf
          * Lines 128 - 144: create linear mixed effects model of percent cover for any coral vs year, random effect for program location ID
          * Lines 145 - 178: create linear mixed effects model of percent cover for any coral vs year, random effect for program location ID, separate for coral region, save output as csv
          * Lines 179 - 201: plot model output as estimated linear trend across years by coral region, save as pdf
          * Lines 202 - 300: format and summarize model output to create summary table of model fit, saved as csv
     * File outputs: `r scrptout(fl)`
     * Potential issues: 
          * Lines 106, 109: Year is dependent variable in the linear model, it should be the independent variable.
          * Model results are separate for each coral region, yet the file includes only one region (Florida Keys). This does not create incorrect output, but the intention is unclear.
```{r}
fl <- scrpt$File[6]
```
1. `r fl`
     * Objective: Import and format percent cover data, create summary boxplots, evaluate percent cover trends by species group across years with linear models.
     * Packages: `r scrptlib(fl)`
     * File inputs: `r scrptinp(fl)`
     * Steps by line number:
          * Lines 1 - 17: load libraries and import percent cover data for Florida Keys
          * Lines 18 - 82: format data for analysis including removal of non-coral taxa, renaming columns, removing `NA` percent cover data, combining genus/species columns, and removing missing rows for genus/species
          * Lines 83 - 102: create a summary table for percent cover statistics by year, species group, region, save output
          * Lines 103 - 108: create linear model year vs percent cover, not separated by species group
          * Lines 109 - 123: create boxplots of percent cover by species group, year, save as pdf
          * Lines 124 - 159: create linear mixed effects model of percent cover for each species group vs year, random effect for program location ID, save as csv
          * Lines 160 - 182: plot model output as estimated linear trend across years by species group, save as pdf
          * Lines 183 - 281: format and summarize model output to create summary table of model fit, saved as csv
     * File outputs: `r scrptout(fl)`
     * Potential issues: 
          * Line 107: Year is dependent variable in the linear model, it should be the independent variable.
```{r}
fl <- scrpt$File[7]
```
1. `r fl`
     * Objective: Import and format percent cover data, create summary boxplots, evaluate percent cover trends by genus across years with linear models.
     * Packages: `r scrptlib(fl)`
     * File inputs: `r scrptinp(fl)`
     * Steps by line number:
          * Lines 1 - 17: load libraries and import percent cover data for Florida Keys
          * Lines 18 - 82: format data for analysis including removal of non-coral taxa, renaming columns, removing `NA` percent cover data, combining genus/species columns, and removing missing rows for genus/species
          * Lines 83 - 102: create a summary table for percent cover statistics by year, genus, region, save output
          * Lines 103 - 109: create linear model year vs percent cover, not separated by genus
          * Lines 110 - 124: create boxplots of percent cover by genus, year, save as pdf
          * Lines 125 - 160: remove genera with less than ten years of data, create linear mixed effects model of percent cover for all genera vs year, random effect for program location ID
          * Lines 161 - 183: create linear mixed effects model of percent cover for each genus vs year, random effect for program location ID, save output as csv
          * Lines 184 - 209: plot model output as estimated linear trend across years by genus, save as pdf
          * Lines 210 - 308: format and summarize model output to create summary table of model fit, saved as csv
     * File outputs: `r scrptout(fl)`
     * Potential issues: 
          * Line 107: Year is dependent variable in the linear model, it should be the independent variable.
```{r}
fl <- scrpt$File[8]
```
1. `r fl`
     * Objective: Import and format percent cover data, create summary boxplots, evaluate percent cover trends for any corals across years with linear models.
     * Packages: `r scrptlib(fl)`
     * File inputs: `r scrptinp(fl)`
     * Steps by line number:
          * Lines 1 - 19: load libraries and import percent cover data for SE Florida
          * Lines 20 - 78: format data for analysis including removal of non-coral taxa, renaming columns, removing `NA` percent cover data, combining genus/species columns, and removing missing rows for genus/species
          * Lines 79 - 100: create a summary table for percent cover statistics by year, region across all species, save output
          * Lines 101 - 111: create linear model year vs percent cover, save model summary plots to pdf
          * Lines 112 - 126: create boxplots of percent cover for any coral by year, save as pdf
          * Lines 127 - 143: create linear mixed effects model of percent cover for any coral vs year, random effect for program location ID
          * Lines 144 - 177: create linear mixed effects model of percent cover for any coral vs year, random effect for program location ID, separate for coral region, save output as csv
          * Lines 178 - 200: plot model output as estimated linear trend across years by coral region, save as pdf
          * Lines 201 - 299: format and summarize model output to create summary table of model fit, saved as csv
     * File outputs: `r scrptout(fl)`
     * Potential issues: 
          * Lines 105, 108: Year is dependent variable in the linear model, it should be the independent variable.
          * Model results are separate for each coral region, yet the file includes only one region (SE Florida). This does not create incorrect output, but the intention is unclear.
```{r}
fl <- scrpt$File[9]
```
1. `r fl`
     * Objective: Import and format percent cover data, create summary boxplots, evaluate percent cover trends by genus across years with linear models.
     * Packages: `r scrptlib(fl)`
     * File inputs: `r scrptinp(fl)`
     * Steps by line number:
          * Lines 1 - 17: load libraries and import percent cover data for SE Florida
          * Lines 18 - 81: format data for analysis including removal of non-coral taxa, renaming columns, removing `NA` percent cover data, combining genus/species columns, and removing missing rows for genus/species
          * Lines 82 - 101: create a summary table for percent cover statistics by year, genus, region, save output
          * Lines 102 - 108: create linear model year vs percent cover, not separated by genus
          * Lines 109 - 123: create boxplots of percent cover by genus, year, save as pdf
          * Lines 124 - 159: remove genera with less than ten years of data, create linear mixed effects model of percent cover for all genera vs year, random effect for program location ID.  No output created because no genus meets the minimum year requirement.
          * Lines 160 - 182: create linear mixed effects model of percent cover for each genus vs year, random effect for program location ID, save output as csv.  No output created because no genus meets the minimum year requirement.
          * Lines 183 - 208: plot model output as estimated linear trend across years by genus, save as pdf.  No output created because no genus meets the minimum year requirement.
          * Lines 209 - 307: format and summarize model output to create summary table of model fit, saved as csv.  No output created because no genus meets the minimum year requirement.
     * File outputs: `r scrptout(fl)`
     * Potential issues: 
          * Line 16: Input file name is incorrect, should be Percent Cover  - SE FL-2021-Jul-26.csv
          * Line 106: Year is dependent variable in the linear model, it should be the independent variable.
          * No output created because no genus meets the minimum year requirement.
```{r}
fl <- scrpt$File[10]
```
1. `r fl`
     * Objective: Import and format percent cover data, create summary boxplots, evaluate percent cover trends by species group across years with linear models.
     * Packages: `r scrptlib(fl)`
     * File inputs: `r scrptinp(fl)`
     * Steps by line number:
          * Lines 1 - 17: load libraries and import percent cover data for SE Florida
          * Lines 18 - 82: format data for analysis including removal of non-coral taxa, renaming columns, removing `NA` percent cover data, combining genus/species columns, and removing missing rows for genus/species
          * Lines 83 - 102: create a summary table for percent cover statistics by year, species group, region, save output
          * Lines 103 - 108: create linear model year vs percent cover, not separated by species group
          * Lines 109 - 123: create boxplots of percent cover by species group, year, save as pdf
          * Lines 124 - 159: create linear mixed effects model of percent cover for each species group vs year, random effect for program location ID, save as csv
          * Lines 160 - 182: plot model output as estimated linear trend across years by species group, save as pdf
          * Lines 183 - 281: format and summarize model output to create summary table of model fit, saved as csv
     * File outputs: `r scrptout(fl)`
     * Potential issues: 
          * Line 107: Year is dependent variable in the linear model, it should be the independent variable.

## Coastal wetlands

### Scripts: {-}

```{r}
scrpt <- scrptflt(fls, 'cw')
kable(scrpt)
```

### Summaries: {-}

```{r}
fl <- scrpt$File[1]
```
1. `r fl`
     * Objective: Import and format richness data, summarize group richness (Marsh, Marsh succulents, Mangroves and associate) by year, month for management areas including plots and linear models
     * Packages: `r scrptlib(fl)`
     * File inputs: `r scrptinp(fl)`
     * Steps by line number:
          * Lines 1 - 23: load libraries and import wetland richness data for all regions
          * Lines 24 - 119: format data for analysis including removal of `NA` data for genus, species, dates, removal of programs with insufficient data, removal of duplicates, formatting of genus, species, date columns, correct misspelled taxa, create unique species list by removing those doubly counted by different programs
          * Lines 120 - 166: remove managed areas that don't have at least five years of data, estimate group richness by management area, year, month
          * Lines 167 - 187: create plots of group richness by management area, year, month
          * Lines 188 - 207: create plots of group richness by management area, year
          * Lines 208 - 224: select one managed area (GTMNERR), create and plot a linear model of group richness by month
          * Lines 225 - 235: create plots of group richness by year, month and by year for selected managed area
          * Lines 236 - 243: create a histogram of group richness for the selected managed area
          * Lines 244 - 279: create a linear model of group richness by year for the selected managed area, plot the results
          * Lines 280 - 298: select one managed area (Guana River Marsh), create and plot a linear model of group richness by month
          * Lines 299 - 309: create plots of group richness by year, month and by year for selected managed area
          * Lines 310 - 317: create a histogram of group richness for the selected managed area
          * Lines 318 - 354: create a linear model of group richness by year for the selected managed area, plot the results
     * File outputs: `r scrptout(fl)`
     * Potential issues: 
          * The plots of richness by year in lines 188 - 207 use the same data to plot richness by month, year and is an incorrect measure of richness within a year.  Unique groups in each year need to be separately calculated.
          * Plots in lines 225 - 235, 299 - 309 are redundant with those in 167 - 207
          * Lines 270 - 278, 344 - 352 are commented code to evaluate linear models with different distribution families, e.g., Poisson, etc. These are worth exploring. 
```{r}
fl <- scrpt$File[2]
```
1. `r fl`
     * Objective: Import and format richness data, summarize species richness by year, month for management areas including plots and linear models
     * Packages: `r scrptlib(fl)`
     * File inputs: `r scrptinp(fl)`
     * Steps by line number:
          * Lines 1 - 23: load libraries and import wetland richness data for all regions
          * Lines 24 - 121: format data for analysis including removal of `NA` data for genus, species, dates, removal of programs with insufficient data, removal of duplicates, formatting of genus, species, date columns, correct misspelled taxa, create unique species list by removing those doubly counted by different programs
          * Lines 122 - 168: remove managed areas that don't have at least five years of data, estimate species richness by management area, year, month
          * Lines 169 - 189: create plots of species richness by management area, year, month
          * Lines 190 - 209: create plots of species richness by management area, year
          * Lines 210 - 226: select one managed area (GTMNERR), create and plot a linear model of species richness by month
          * Lines 227 - 237: create plots of species richness by year, month and by year for selected managed area
          * Lines 238 - 245: create a histogram of species richness for the selected managed area
          * Lines 246 - 281: create a linear model of species richness by year for the selected managed area, plot the results
          * Lines 282 - 300: select one managed area (Guana River Marsh), create and plot a linear model of species richness by month
          * Lines 301 - 311: create plots of species richness by year, month and by year for selected managed area
          * Lines 312 - 319: create a histogram of species richness for the selected managed area
          * Lines 320 - 356: create a linear model of species richness by year for the selected managed area, plot the results
     * File outputs: `r scrptout(fl)`
     * Potential issues: 
          * The plots of richness by year in lines 190 - 209 use the same data to plot richness by month, year and is an incorrect measure of richness within a year.  Unique species in each year need to be separately calculated.
          * Plots in lines 227 - 237, 301 - 311 are redundant with those in 169 - 209
          * Lines 272 - 280, 346 -354 are commented code to evaluate linear models with different distribution families, e.g., Poisson, etc. These are worth exploring. 

## Submered aquatic vegetation

### Scripts: {-}

```{r}
scrpt <- tibble(
  Index = '1', 
  File = 'SEACAR_SAV_BB_script.R',
  Link = '[link](https://github.com/FloridaSEACAR/SAV_CLR/blob/main/SEACAR_SAV_BB_script.R) - private repo'
)
kable(scrpt)
```

### Summaries: {-}

```{r}
fl <- 'SEACAR_SAV_BB_script.R'
```

1. SECAR_SAV_BB_script.R
     * Objective:
     * Packages: `r scrptlib(fl)`
     * File inputs: `r scrptinp(fl)`
     * Steps by line number:
          * Line 
     * File outputs: Multiple binary RDS files.
     * Potential issues:


<!-- ## Oyster reef -->

<!-- ### Scripts: {-} -->

<!-- ```{r} -->
<!-- scrpt <- scrptflt(fls, 'oy') -->
<!-- kable(scrpt) -->
<!-- ``` -->

<!-- ### Summaries: {-} -->

<!-- 1. `r scrpt$File[1]` -->
<!-- 1. `r scrpt$File[2]` -->

<!-- ### Summaries: {-} -->

<!-- 1. `r scrpt$File[1]` -->

# General comments

* Leverage more tools from the tidyverse for more concise, streamline coding. For example, use `case_when` instead of nested `ifelse` statements. 
* Modularize the parts of copied code in functions.  For example, the scripts for water quality variables are all very similar.  Functions could be created to remove NAs, filter by QA codes, create summary plots, run trend tests, and format results.  
* General issue with portability, environment for analysis is not isolated, i.e., scripts were created on a local computer and specific setup was unknown.  Could be solved by package devevelopment, possibly combined with Docker container.  Use of `rm(list = ls()` at the top of many scripts demonstrates the problem.   
* Many scripts use `install.packages()` which is not necessary for running the scripts in production.
* Some libraries are loaded more than once (e.g., tidyverse, then dplyr which is included in tidyverse, as in lines 25-29 [here](https://github.com/FloridaSEACAR/SEACAR/blob/master/2021.08.21_FINAL_SEACAR%20Water_Nutrients_Phosphorus_FINAL.R)).  This does not impact performance but creates challenges for tracking dependencies. All relevant libraries should be entered at the top of each script.
* Use of logical values entered as text strings (e.g., line 151 [here](https://github.com/FloridaSEACAR/SEACAR/blob/master/2021.08.21_FINAL_SEACAR%20Water_Nutrients_Phosphorus_FINAL.R)) is incorrect and should use the actual atomic values, i.e., `TRUE`, `FALSE`.
* Water quality trend tests are based on average year, month values.  Is it possible to run these tests without averaging first?  This reduces sample size and removes real variability that could influence the outcome.
* Month, year summary boxplots for water column variables are difficult to interpret as all values are chronological, maybe better to show just month on x-axis, then facet by year. 
* Output files created with sink create a csv but this would be more appropriate as a text file since these are not tabular data (e.g., line 361 [here](https://github.com/FloridaSEACAR/SEACAR/blob/master/2021.08.21_FINAL_SEACAR_Water%20Clarity_chla_Final.R)).
* Formatted water column tables with trend statistics for water column data should have number of years for which the trend applies, in addition to min/max years. The time series for each managed area are all different and it's useful to provide this information. 
* Data I/O needs to be evaluated.  All scripts use files from a local path and outputs are saved in the working directory.  This is an issue to be solved in production. 
* For corals, analyses were requested separately by sampling type: fixed or random.  Note that this refers to sampling method, not a statistical test. However, the scripts indicate that sample information is unavailable in the input data (e.g., line 22 [here](https://github.com/FloridaSEACAR/SEACAR/blob/main/FINAL_2021.09.18_DryTort%20Region_Any%20Corals.R)).  The analyses are not done at this time.  
* For corals, trends in percent cover are assessed using linear mixed-effects models.  It may be worth confirming trends using non-parametric analogs, particular since percent cover is generally a right-skewed variable. There also is not a minimum year requirement for tests in percent cover evaluating any coral and for species groups, unlike trends tests for other habitats (i.e., water column). However, there is a minimum year requirement for tests evaluating genera.
* Trend tests for percent cover of coral by genus require a minimum of ten years of data. For the Dry Tortugas and SE Florida region, no genus meet the criteria.  The analysis script returns errors as opposed to informative output indicating insufficient data.  This is an issue that could be solved through package development, e.g., using `stopifnot()`, or other error handling so that analyses don't "break" in production when test criteria are unmet. 
* As with other habitat types, the coral analyses could be greatly simplified by creating functions that accomplish routine tasks. Each analysis is similar - for each region, create a linear model of percent cover across years, with separate models for all taxa combined, by genus, or by species groups.  Standardized outputs are also created, e.g., plots of model predictions, tables of model summaries, plots of observed data, etc.  All of this can be turned into functions, including appropriate exceptions within each function to handle unique cases (e.g., filter genus data for those with at least ten years of data).
* Coastal wetlands scripts only evaluate richness.  There were no analyses evaluating percent cover, which were indicated as an outcome in supplementary documents.
* Coastal wetlands analyses filter managed areas that do not have at least five years of data.  Other analyses use ten years as a criteria.  Is there a justification for choosing a minimum number of years?